## Гибридный протокол: DTTSG (DAN + TDMA/TWR + Swarm Gradient)

Цель: Создать адаптивную, точную и самоорганизующуюся сеть для 3D-позиционирования и коллективных задач в реальном времени.
1. Архитектура протокола
1.1. Динамическая структура кадра

Кадр делится на три сегмента, пропорции которых адаптируются под текущее число узлов NN:
Сегмент	Доля времени	Описание
DAN-слоты	40%	Передача служебных данных: ID, статус батареи, NN, приоритет задач. Guard-slot для добавления узлов.
TWR-слоты	40%	Двусторонние измерения расстояний между узлами. Приоритет для "горячих" юнитов (скорость > 2 м/с).
Swarm-слоты	20%	Передача параметров роевого поведения: коэффициенты разделения, сплочения, целевые позиции.

Формула длительности кадра:
Tframe=TDAN+TTWR+TSwarm=100 мс (по умолчанию)
Tframe​=TDAN​+TTWR​+TSwarm​=100мс(по умолчанию)

    При изменении NN длительность сегментов пересчитывается:
    TDAN=0.4⋅Tframe,TTWR=0.4⋅Tframe,TSwarm=0.2⋅Tframe
    TDAN​=0.4⋅Tframe​,TTWR​=0.4⋅Tframe​,TSwarm​=0.2⋅Tframe​

2. Технические детали
2.1. Реализация DAN-слотов

    Guard-slot алгоритм:

        Новые узлы сканируют эфир, обнаруживают текущее NN, ждут guard-slot.

        Join-запрос включает ID и начальные координаты (если известны).

        Существующие узлы подтверждают добавление, увеличивают NN и перестраивают кадр.

    Пакет данных в слоте:
   
            struct DanPacket {
                uint16_t id;          // ID юнита
                float x, y, z;        // Координаты (Q8.8 формат)
                float vx, vy, vz;     // Скорость (м/с)
                uint8_t battery;      // Уровень заряда (0-100%)
                uint16_t crc;         // CRC16 для проверки целостности
            } __attribute__((packed));  // Размер: 24 байта

2.2. TWR-измерения

    Алгоритм двустороннего ranging:

        Узел A отправляет пакет с меткой времени t1t1​.

        Узел B принимает его в t2t2​, отправляет ответ в t3t3​.

        Узел A получает ответ в t4t4​.

        Расстояние вычисляется как:
        d=c⋅((t4−t1)−(t3−t2))2,c=3⋅108 м/с
        d=2c⋅((t4​−t1​)−(t3​−t2​))​,c=3⋅108м/с

        Погрешность: ±10 см (для DWM3000).

    Приоритезация измерений:

        Каждый узел измеряет расстояния до 3 ближайших соседей.

        Приоритет отдается узлам с ∣v∣>2 м/с∣v∣>2м/с или d<1 мd<1м.

2.3. Swarm Gradient

Силы роевого поведения:

    Разделение (Separation):
    Fsep=−∑i=1k1di2⋅(pself−pi)
    Fsep​=−i=1∑k​di2​1​⋅(pself​−pi​)

    Сплочение (Cohesion):
    Fcoh=1k∑i=1k(pi−pself)
    Fcoh​=k1​i=1∑k​(pi​−pself​)

    Целевое притяжение (Task):
    Ftask=wtask⋅(ptarget−pself)
    Ftask​=wtask​⋅(ptarget​−pself​)

Итоговое движение:
pnew=pold+Δt⋅(v+Fsep+Fcoh+Ftaskm),m=1 (виртуальная масса)
pnew​=pold​+Δt⋅(v+mFsep​+Fcoh​+Ftask​​),m=1(виртуальная масса)
3. Интеграция с UWB (DWM3000)
3.1. Настройка модуля

    Режим работы: TWR инициируется по прерыванию от таймера.

    Формат пакета:
    python
    Copy

    struct TwrPacket {
        uint16_t id;
        uint32_t t1, t2, t3, t4;  // Метки времени в нс
    } __attribute__((packed));  // Размер: 18 байт

    Синхронизация: Децентрализованный PTP через UWB-метки. Погрешность: ±100 нс.

3.2. Оптимизации для Raspberry Pi Zero

    Фиксированная арифметика:
    Координаты и силы хранятся в формате Q8.8 (16 бит: 8 целых, 8 дробных).
    Пример:
    12.75→1210=000011002,0.7510=110000002⇒00001100.11000000
    12.75→1210​=000011002​,0.7510​=110000002​⇒00001100.11000000

    Многопоточность:

        Поток 1: Обработка UWB (драйвер DWM3000, прерывания).

        Поток 2: Расчет Swarm Gradient (каждые 25 мс).

        Поток 3: Сетевое взаимодействие (MQTT для удаленного управления).

4. Примеры сценариев
4.1. Построение 3D-сферы

    Инициирование задачи:
    Лидер рассылает в Swarm-слоте:
    json
    Copy

    {"task": "shape", "type": "sphere", "radius": 5.0, "center": [0, 0, 0]}

    Распределение позиций:
    Каждый узел вычисляет свою целевую точку:
    θi=2π⋅IDN,ϕi=π⋅IDN,x=r⋅sin⁡(θ)cos⁡(ϕ),y=r⋅sin⁡(θ)sin⁡(ϕ),z=r⋅cos⁡(θ)
    θi​=N2π⋅ID​,ϕi​=Nπ⋅ID​,x=r⋅sin(θ)cos(ϕ),y=r⋅sin(θ)sin(ϕ),z=r⋅cos(θ)

    Коррекция траектории:

        TWR-данные обновляются каждые 20 мс.

        Swarm-силы корректируют позицию каждые 25 мс.

4.2. Избегание препятствий

    Экстренный режим: При d<0.3 мd<0.3м к соседу:
    Femergency=10⋅Fsep,v=0 на 0.5 с.
    Femergency​=10⋅Fsep​,v=0на0.5с.

5. Сравнение с аналогами
Параметр	DAN + TWR + Swarm	Чистый DAN	Централизованный TDoA
Точность	±0.2 м	±1.0 м	±0.1 м
Частота обновления	40 Гц	20 Гц	100 Гц
Децентрализация	Да	Да	Нет
Сложность	Высокая	Средняя	Низкая
6. Проблемы и решения
Проблема	Решение
Коллизии в guard-slot	Raft-алгоритм: Временный лидер управляет добавлением узлов.
Рост задержек при N > 30	Кластеризация: Сеть делится на группы по 10-15 узлов.
Низкая точность Swarm	Коррекция через TWR каждые 3 кадра.
7. Заключение

Гибридный протокол DAN + TDMA/TWR + Swarm Gradient обеспечивает:

    Адаптивность к динамическим изменениям сети.

    Точность до 20 см в 3D-пространстве.

    Роевой интеллект для коллективных задач.

Стек технологий:

    Аппаратная платформа: Raspberry Pi Zero + DWM3000.

    Протоколы: UWB TWR, децентрализованный PTP.

    Оптимизации: Фиксированная арифметика, многопоточность.

Перспективы:

    Интеграция с машинным обучением для предсказания траекторий.

    Поддержка LiDAR для обнаружения препятствий.

